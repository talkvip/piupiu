<script src="microphone.js"></script>
<div id="debug"></div>
<script>
var proc = null;
var run = 0;
var prev = '';
var timedBuffer = [];

var minFreq = 1760.0;
var noteRatio = 1.0594630943591;
var noteStrings = '0123456789abcdefghijklmnopqrstuv';
var notesTable = {};
for(var i = 0; i < noteStrings.length; i++) {
  notesTable[noteStrings[i]] = minFreq * Math.pow(noteRatio, i);
}
console.log(notesTable);
var mic = new Microphone({notes: notesTable, callback: function micCallback(ev) {
  console.log(ev);
  if(ev.event == 'gotstream') {
    mic.startListening();
  }
  if(ev.event == 'listening') {
    analyse();
    setTimeout(function() {
      cancelAnimationFrame(proc);
      analyseBuffer();
      mic.stopListening();
    }, 5000);  
  }
}});

mic.initialize();

function analyse() {
  proc = requestAnimationFrame(analyse);
  var freq = mic.getFreq(2);
  var note = mic.getNote(2);
  if(freq >= minFreq - 100) {
    timedBuffer['_' + new Date().getTime()] = note;
    console.log(freq, note);
  }
}

function analyseBuffer() {
  console.log(timedBuffer);
  // analyse timedBuffer
  var hTime = -1;
  var startTime = -1;
  for(var t in timedBuffer) {
    if(hTime != -1 && timedBuffer[t] == 'j') {
      startTime = parseFloat(t.substring(1));
      break;
    }
    if(timedBuffer[t] == 'h') {
      hTime = parseFloat(t.substring(1));
    }
  }
  console.log(hTime);
  console.log(startTime);
  if(hTime == -1 && startTime == -1) return;
  if(startTime == -1) startTime = hTime + 82.7;
  startTime += 82.7;
  var endTime = startTime + (82.7 * 19);
  console.log(startTime);
  console.log(endTime);
  var charBuffer = [];
  var prev = -1;
  for(var t in timedBuffer) {
    f = parseFloat(t.substring(1));
    if(f > endTime) break;
    if(f >= startTime) {
      var i = parseInt((f - startTime) / 82.7);
      if(typeof charBuffer[i] == 'undefined') charBuffer[i] = [];
      charBuffer[i].push(timedBuffer[t]);
      if(prev > 0) {
        if(charBuffer[i][0] == charBuffer[prev][charBuffer[prev].length - 1]) {
          charBuffer[i] = [];              
          charBuffer[prev].push(timedBuffer[t]);
        }
      }
      prev = i;
    }
  }
  console.log(charBuffer);
  document.getElementById('debug').innerText = JSON.stringify(charBuffer);
  var noteBuffer2 = [];
  var charBuffer2 = [];
  var chirp = '';
  for(var i in charBuffer) {
    var arr2 = charBuffer[i];
    if(arr2.length > 1) {
      var newArr = arr2.slice().sort(), most = [undefined, 0], counter = 0;
      newArr.reduce(function(old, chr){
         old == chr ? ++counter > most[1] && (most = [chr, counter]) : (counter = 1)
         return chr
      });          
      charBuffer2[i] = most[0];
    } else {
      charBuffer2[i] = charBuffer[i][0];
    }
    chirp += charBuffer2[i];
  }
  console.log(noteBuffer2);
  console.log(chirp);
  //alert(chirp);
  var a = document.createElement('a');
  var url = 'http://labs.chirp.io/get/' + chirp.substring(0, 10);
  a.setAttribute('href', url);
  a.setAttribute('target', '_blank');
  a.innerText = url;
  document.getElementById('debug').innerText = '';
  document.getElementById('debug').appendChild(a);
  timedBuffer = [];
}
</script>